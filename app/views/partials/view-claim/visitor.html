{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/date-input/macro.njk" import govukDateInput %}


{% if Children[0] %}
  {% set tableCaption = 'Visitors' %}
{% else %}
  {% set tableCaption = 'Visitor' %}
{% endif %}

{% if Children %}
  {% set visitorType = 'Lead visitor' %}
{% else %}
  {% set visitorType = 'Visitor' %}
{% endif %}

{% set contactDetails %}
  <a href="mailto:{{ Claim.EmailAddress }}">{{ Claim.EmailAddress }}</a>
  {% if unlock %}
    <a href="/claim/{{ Claim.ClaimId }}/update-contact-details" class="change">Change</a>
  {% endif %}
{% endset %}

{% set benefit %}
  {{ displayHelper.getBenefitDisplayName(Claim.Benefit) }}
  {% if unlock %}
  {{ govukSelect({
    formGroup: {
      classes: 'select-for-form'
    },
    id: "dwp-status",
    name: "dwpCheck",
    classes: 'action-select',
    errorMessage: errors['dwp-check'][0],
    items: [
      {
        value: "APPROVED",
        text: "Approve",
        selected: Claim.DWPCheck === 'APPROVED'
      },
      {
        value: "REQUEST-INFORMATION",
        text: "Request information",
        selected: Claim.DWPCheck === 'REQUEST-INFORMATION'
      },
      {
        value: "REJECTED",
        text: "Reject",
        selected: Claim.DWPCheck === 'REJECTED'
      }
    ]
  }) }}
  {% endif %}
  <br/>


  {% if displayHelper.getBenefitRequireUpload(Claim.Benefit) or Claim.benefitDocument.length > 0 %}
    {% for document in Claim.benefitDocument %}
      {% if document.DocumentStatus == 'uploade' %}
        <a href="/claim/{{ Claim.ClaimId }}/download?claim-document-id={{ document.ClaimDocumentId }}">View evidence</a>
      {% elif document.DocumentStatus == 'upload-later' %}
        <span class="text-pending">To be uploaded later</span>
        {% if unlock %}
          <a href="/claim/file-upload/{{ Claim.Reference }}/{{ Claim.ClaimId }}/{{ Claim.Benefit }}?eligibilityId={{ Claim.EligibilityId }}&claimDocumentId={{ document.ClaimDocumentId }}" id="add-benefit-documentation-upload-later" class="button grey pull-right">Add</a>
        {% endif %}
      {% elif document.DocumentStatus == 'uploaded' %}
        <span class="text-pending">To be posted later</span>
        {% if unlock %}
          <a href="/claim/file-upload/{{ Claim.Reference }}/{{ Claim.ClaimId }}/{{ Claim.Benefit }}?eligibilityId={{ Claim.EligibilityId }}&claimDocumentId={{ document.ClaimDocumentId }}" id="add-benefit-documentation-post-later" class="button grey pull-right">Add</a>
        {% endif %}
      {% else %}
        <span class="text-warning">Benefit required</span>
      {% endif %}
    {% endfor %}
  {% else %}
    {% if Claim.DWPBenefitCheckerResult == 'YES' %}
      <span class="text-success">DWP - Eligible</span>
    {% elif Claim.DWPBenefitCheckerResult == 'NO' %}
      <span class="text-warning">DWP - Not eligible</span>
    {% elif Claim.Benefit == 'YCS' %}
      <span class="text-success">DWP - Not applicable</span>
    {% else %}
      <span class="text-warning">DWP - No information</span>
    {% endif %}
  {% endif %}
{% endset %}

{% set expiryDate %}
  {% if unlock %}
    
    {{ govukDateInput({
      id: "expiry-date-section",
      namePrefix: "expiry-date-section",
      errorMessage: errors['benefit-expiry'][0] ,
      formGroup: {
        classes: 'govuk-!-margin-bottom-0'
      },
      items: [
        {
          name: "day",
          id: "expiry-day-input",
          type: "number",
          classes: "govuk-input--width-2",
          value: Claim.expiryDay
        },
        {
          name: "Month",
          id: "expiry-month-input",
          type: "number",
          classes: "govuk-input--width-2",
          value: Claim.expiryMonth
        },
        {
          name: "year",
          id: "expiry-year-input",
          type: "number",
          classes: "govuk-input--width-4",
          value: Claim.expiryYear
        }
      ]
    }) }}

    <input type="submit" formaction="/claim/{{ Claim.ClaimId }}/update-benefit-expiry-date" class="button pull-right grey" name="update-benefit-expiry-date" id="update-benefit-expiry-date" value="Save benefit expiry date">
  {% else %}
    {% if Claim.BenefitExpiryDate %}
      <div id="benefit-expiry-date">{{ getDateFormatted.shortDate(Claim.BenefitExpiryDate) }}</div>
    {% else %}
      <span class="text-pending">Pending</span>
    {% endif %}
  {% endif %}
{% endset %}

{% set childData = [] %}
{% for child in Children %}
  {% set childInfo = '<span>' + child['FirstName'] + ' ' + child['LastName'] + '<br>' + getDateFormatted.shortDate(child['DateOfBirth']) + '<br>' + getChildFormatted(child['Relationship']) + '</span>' %}
  {% set childRow = [
    {
      html: '<br>Child ' + loop.index + '<br>',
      classes: "claim-table-width-one-third"
    },
    {
      html: childInfo,
      classes: "govuk-!-width-two-thirds"
    }
  ] %}
  {% set childData = childData | concat([childRow]) %}
{% endfor %}

{% if Escort %}
  {% set escort = [
    {
      html: 'Escort',
      classes: "claim-table-width-one-third"
    },
    {
      html: Escort['FirstName'] + ' ' + Escort['LastName'] + '<br>' + getDateFormatted.shortDate(Escort['DateOfBirth']),
      classes: "govuk-!-width-two-thirds"
    }
  ] %}
{% endif %}



{{ govukTable({
  caption: tableCaption | safe,
  captionClasses: "govuk-table__caption--l",
  firstCellIsHeader: true,
  classes: 'govuk-!-margin-bottom-0',
  rows: [
    [
      {
        text: visitorType | safe,
        classes: "claim-table-width-one-third"
      },
      {
        text: Claim['FirstName'] + ' ' + Claim['LastName'],
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        text: 'Date of birth',
        classes: "claim-table-width-one-third"
      },
      {
        text: getDateFormatted.shortDate(Claim['DateOfBirth']),
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        text: 'National Insurance number',
        classes: "claim-table-width-one-third"
      },
      {
        text: Claim['NationalInsuranceNumber'],
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        html: '<br><br>Home address<br><br><br>',
        classes: "claim-table-width-one-third"
      },
      {
        html: Claim['HouseNumberAndStreet'] + '<br>' + Claim['Town'] + '<br>' + Claim['County'] + '<br>' + Claim['PostCode'] + '<br>' + Claim['Country'],
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        text: 'Contact details',
        classes: "claim-table-width-one-third"
      },
      {
        html: contactDetails | safe,
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        text: 'Prisoner relationship',
        classes: "claim-table-width-one-third"
      },
      {
        html: prisonerRelationshipsEnum[Claim['Relationship']].displayName,
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        html: 'Benefit Information <br><br>',
        classes: "claim-table-width-one-third",
        errorMessage: errors['dwp-check'][0],
        id: "benefit-expiry"
      },
      {
        html: benefit + '<br>',
        classes: "govuk-!-width-two-thirds"
      }
    ],
    [
      {
        text: 'Benefit Expiry',
        classes: "claim-table-width-one-third",
        errorMessage: errors['benefit-expiry'][0],
        id: "dwp-check"
      },
      {
        html: expiryDate,
        classes: "govuk-!-width-two-thirds"
      }
    ]
  ]
}) }}

{{ govukTable({
  firstCellIsHeader: true,
  classes: 'govuk-!-margin-bottom-0',
  rows: childData
}) }}

{% if escort %}
  {{ govukTable({
    firstCellIsHeader: true,
    classes: 'govuk-!-margin-bottom-0',
    rows: [escort]
  }) }}
{% endif %}

{{ govukTable({
  firstCellIsHeader: true,
  rows: [
    [
      {
        text: 'Payment method',
        classes: "claim-table-width-one-third table-no-border-bottom"
      },
      {
        html: displayHelper.getPaymentMethodDisplayName(Claim['PaymentMethod']),
        classes: "govuk-!-width-two-thirds table-no-border-bottom"
      }
    ]
  ]
}) }}


